<!DOCTYPE html>
<html>
	<head>
		<title>Oatmeal Lite</title>
		<script>
			(function() {
				var username
				var currRoom

				function enterChatRooms(){
					let possName = document.getElementById("nameinput").value;
					if (possName != ""){
						username = possName;
						currRoom = "general"
						document.getElementById("signin").style.display = "none";
						document.getElementById("chatmain").style.display = "block";
						fetch("http://localhost:3000?mode=adduser&name=" + username)
					}
				}

				function getData(){
					fetch("http://localhost:3000?mode=getdata&name=" + username).then(checkStatus)
						.then(function(responseText){
							//successfully received data
							let serverJSON = JSON.parse(responseText);
							console.log(serverJSON)
							let currentComments = getComments(serverJSON.allUsers)
							console.log(currentComments)
							let currentRoomUsers = getRoomUsers(serverJSON)
							let currentAllUsers = serverJSON.allUsers
							updateLocalPage(currentComments, currentRoomUsers, currentAllUsers)
						})
						.catch(function(error){//error
							console.log(error)
						});
				}

				function postComment(){
					fetch("http://localhost:3000?mode=postcomment&name=" + username + "&comment=" + document.getElementById("commentinput").value)
					document.getElementById("commentinput").value = ""
				}

				function getComments(allUsers){
					for (let i = 0; i < allUsers.length; i++){
						if (allUsers[i].name == username){
							currRoom = allUsers[i].currRoom
							return allUsers[i].currRoom.chat
						}
					}
				}

				function getRoomUsers(serverJSON){
					let allUsers = serverJSON.allUsers
					let roomUsers = []
					for (let i = 0; i < allUsers.length; i++){
						if (allUsers[i].currRoom.name == currRoom.name){
							roomUsers.push(allUsers[i])
						}
					}
					return roomUsers
				}

				function updateLocalPage(currentComments, currentRoomUsers, currentAllUsers){
					let commentSection = document.getElementById("commentlist")
					let allUsersList = document.getElementById("alllist")
					let roomUsersList = document.getElementById("roomlist")
					commentSection.innerHTML = ""
					allUsersList.innerHTML = ""
					roomUsersList.innerHTML = ""
					document.getElementById("chatroomtitle").innerHTML = "Currently in Chat Room: <u>" + currRoom.name + "</u>"
					for (let i = 0; i < currentComments.length; i++){
						let commentItem = document.createElement("li")
						commentItem.innerHTML = "<b>" + currentComments[i].person + "</b>: " + currentComments[i].text
						commentSection.appendChild(commentItem)
					}
					for (let i = 0; i < currentRoomUsers.length; i++){
						let roomUserItem = document.createElement("li")
						roomUserItem.innerHTML = currentRoomUsers[i].name
						roomUsersList.appendChild(roomUserItem)
					}
					for (let i = 0; i < currentAllUsers.length; i++){
						let allUserItem = document.createElement("li")
						allUserItem.innerHTML = currentAllUsers[i].name
						allUsersList.appendChild(allUserItem)
					}
				}

				function checkStatus(response){
					if (response.status >= 200 && response.status < 300){
						return response.text();
					}else{
						return Promise.reject(new Error(response.status + ":" + response.statusText));
					}
				}

				window.onload = function(){

					document.getElementById("submitname").onclick = enterChatRooms;
					document.getElementById("nameinput").onkeypress = function(event){
						if (event.keyCode == 13){
							enterChatRooms();
						}
					}

					document.getElementById("submitcomment").onclick = postComment;
					document.getElementById("commentinput").onkeypress = function(event){
						if (event.keyCode == 13){
							postComment();
						}
					}
					setInterval(getData, 100)

				};
			})();
		</script>
		<style>
			#users {
				display: flex;
				justify-content: center;
				margin-left: auto;
				margin-right: auto;
				width: 30%;
				border: 2px solid black;
				height: 150px;
				overflow-y: scroll;
			}

			#users div{
				margin: 10px;
			}

			#commentbox {
				margin-left: auto;
				margin-right: auto;
				width: 50%;
				height: 300px;
				overflow-y: scroll;
				border: 2px solid black;
			}

			ul {
				list-style-type: none;
				text-align: left;
			}

			.hidden {
				display: none;
			}

			.shown {
				display: block;
			}

			body {
				text-align: center;
			}

			#signin, #commentpostsection {
				margin-top: 30px;
			}
		</style>
	</head>
	<body>
		<h1>Welcome to the Discussion</h1>
		<div id="signin" class="shown">
			<label>Name: <input type="text" id="nameinput" /></label>
			<button id="submitname">Get Started!</button>
		</div>
		<div id="chatmain" class="hidden">
			<h2 id="chatroomtitle">Currently in Chat Room: </h2>
			<div id="users">
				<div id="roomusers">
					<h3>Users in Room:</h3>
					<ul id="roomlist">
					</ul>
				</div>
				<div id="allusers">
					<h3>All Users Online:</h3>
					<ul id="alllist">
					</ul>
				</div>
			</div>
			<h3>Live Chat:</h3>
			<div id="commentbox">
				<ul id="commentlist">
				</ul>
			</div>
			<div id="commentpostsection">
				<label>What's on your mind?: <input type="text" id="commentinput" /></label>
				<button id="submitcomment">Send</button>
			</div>
		</div>
	</body>
</html>